<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoctorQ Monitor - Cabinet Dr. Kamoun</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 20px 0 30px;
    }

    .header h1 {
      font-size: 1.6rem;
      color: #38bdf8;
      margin-bottom: 5px;
    }

    .header .clinic-name {
      color: #94a3b8;
      font-size: 1rem;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 12px 20px;
      background: #1e293b;
      border-radius: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.green { background: #22c55e; box-shadow: 0 0 8px #22c55e50; }
    .status-dot.red { background: #ef4444; box-shadow: 0 0 8px #ef444450; }
    .status-dot.yellow { background: #eab308; box-shadow: 0 0 8px #eab30850; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Login Required */
    .login-required {
      background: linear-gradient(135deg, #7c2d12 0%, #451a03 100%);
      border: 1px solid #ea580c;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 25px;
    }

    .login-required h2 {
      color: #fb923c;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .login-required p {
      color: #fed7aa;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .login-required .btn {
      display: inline-block;
      background: #ea580c;
      color: white;
      padding: 12px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }

    .login-required .btn:hover {
      background: #c2410c;
      transform: translateY(-2px);
    }

    /* Primary Metrics Grid */
    .metrics-primary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .card.highlight {
      background: linear-gradient(135deg, #0c4a6e 0%, #164e63 100%);
      border: 2px solid #0ea5e9;
    }

    .card .label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .card .value {
      font-size: 3rem;
      font-weight: 700;
      color: #f8fafc;
      line-height: 1;
      margin-bottom: 8px;
    }

    .card .unit {
      font-size: 0.85rem;
      color: #64748b;
    }

    .card .reset-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #fca5a5;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card .reset-btn:hover {
      background: #ef4444;
      color: white;
    }

    /* Secondary Metrics */
    .metrics-secondary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-small {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .card-small .label {
      font-size: 0.7rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .card-small .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #e2e8f0;
    }

    .card-small .unit {
      font-size: 0.75rem;
      color: #475569;
    }

    .card-small.doctor-present .value {
      color: #22c55e;
    }

    .card-small.doctor-absent .value {
      color: #ef4444;
    }

    /* Current Patient Card */
    .current-patient {
      background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
    }

    .current-patient.empty {
      background: #1e293b;
      border: 2px dashed #334155;
    }

    .current-patient .row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .current-patient .row:last-child {
      margin-bottom: 0;
    }

    .current-patient .badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .current-patient .name {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .current-patient .next-label {
      color: #a7f3d0;
      font-size: 0.85rem;
    }

    .current-patient .next-name {
      color: #d1fae5;
    }

    /* Action Buttons */
    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: #0ea5e9;
      color: white;
    }

    .btn-primary:hover {
      background: #0284c7;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    /* Activity Log */
    .log-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
    }

    .log-section h3 {
      color: #94a3b8;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-section h3::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #0ea5e9;
      border-radius: 2px;
    }

    .log {
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .log::-webkit-scrollbar {
      width: 6px;
    }

    .log::-webkit-scrollbar-track {
      background: #0f172a;
      border-radius: 3px;
    }

    .log::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 3px;
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #334155;
      display: flex;
      gap: 12px;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #475569;
      flex-shrink: 0;
    }

    .log-message {
      color: #94a3b8;
    }

    .log-entry.success .log-message { color: #4ade80; }
    .log-entry.error .log-message { color: #f87171; }
    .log-entry.info .log-message { color: #60a5fa; }

    /* Flash Animation */
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; background: #0ea5e920; }
    }

    .flash {
      animation: flash 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container { padding: 15px; }
      .header h1 { font-size: 1.3rem; }
      .card .value { font-size: 2.5rem; }
      .metrics-secondary { grid-template-columns: repeat(2, 1fr); }
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>DoctorQ Monitor</h1>
      <div class="clinic-name">Cabinet Dr. Skander Kamoun</div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot" id="apiStatus"></div>
        <span>API</span>
      </div>
      <div class="status-item">
        <div class="status-dot" id="socketStatus"></div>
        <span>Socket</span>
      </div>
      <div class="status-item">
        <span style="color: #64748b;">Dernière maj:</span>
        <span id="lastUpdate">--:--:--</span>
      </div>
    </div>

    <!-- Login Required (hidden by default) -->
    <div class="login-required" id="loginRequired" style="display: none;">
      <h2>Connexion requise</h2>
      <p>
        Pour voir les statistiques en temps réel, connectez-vous d'abord au tableau de bord principal.
        <br>Le token d'authentification sera automatiquement partagé.
      </p>
      <a href="https://web-zeta-five-39.vercel.app" target="_blank" class="btn">
        Ouvrir le Dashboard
      </a>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div id="mainContent">
      <!-- Primary Metrics -->
      <div class="metrics-primary">
        <div class="card highlight">
          <div class="label">En attente</div>
          <div class="value" id="waiting">-</div>
          <div class="unit">patients</div>
        </div>

        <div class="card">
          <div class="label">Vus aujourd'hui</div>
          <div class="value" id="seen">-</div>
          <div class="unit">consultations</div>
          <button class="reset-btn" onclick="resetStats()" title="Remettre à zéro">Reset</button>
        </div>

        <div class="card">
          <div class="label">Temps moyen</div>
          <div class="value" id="avgWait">-</div>
          <div class="unit">min d'attente</div>
        </div>

        <div class="card">
          <div class="label">Non présentés</div>
          <div class="value" id="noShows">-</div>
          <div class="unit">aujourd'hui</div>
        </div>
      </div>

      <!-- Secondary Metrics -->
      <div class="metrics-secondary">
        <div class="card-small">
          <div class="label">Temps max</div>
          <div class="value" id="maxWait">-</div>
          <div class="unit">minutes</div>
        </div>

        <div class="card-small">
          <div class="label">Dernière consult.</div>
          <div class="value" id="lastConsult">-</div>
          <div class="unit">minutes</div>
        </div>

        <div class="card-small" id="doctorCard">
          <div class="label">Docteur</div>
          <div class="value" id="doctorStatus">-</div>
          <div class="unit" id="doctorLabel">statut</div>
        </div>

        <div class="card-small">
          <div class="label">Connexions</div>
          <div class="value" id="connections">-</div>
          <div class="unit">actives</div>
        </div>
      </div>

      <!-- Current Patient -->
      <div class="current-patient empty" id="currentPatientCard">
        <div class="row">
          <span class="badge">En consultation</span>
          <span class="name" id="currentPatient">Aucun patient</span>
        </div>
        <div class="row">
          <span class="next-label">Prochain:</span>
          <span class="next-name" id="nextPatient">-</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="actions">
        <a href="https://web-zeta-five-39.vercel.app" target="_blank" class="btn btn-primary">
          Ouvrir Dashboard
        </a>
        <button class="btn btn-secondary" onclick="refresh()">
          Rafraichir
        </button>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="log-section">
      <h3>Journal d'activité</h3>
      <div class="log" id="log">
        <div class="log-entry info">
          <span class="log-time">--:--:--</span>
          <span class="log-message">En attente de connexion...</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const API_URL = 'https://doctorqapi-production-ac8b.up.railway.app';
    const AUTH_TOKEN = localStorage.getItem('auth_token') || '';

    let socket = null;
    const logEntries = [];
    let clinicId = null;

    // Logging
    function addLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString('fr-FR');
      logEntries.unshift({ time, message, type });
      if (logEntries.length > 20) logEntries.pop();
      renderLog();
    }

    function renderLog() {
      const logEl = document.getElementById('log');
      logEl.innerHTML = logEntries.map(e =>
        `<div class="log-entry ${e.type}">
          <span class="log-time">${e.time}</span>
          <span class="log-message">${e.message}</span>
        </div>`
      ).join('');
    }

    // Status indicators
    function setStatus(id, status) {
      const dot = document.getElementById(id);
      dot.className = 'status-dot ' + status;
    }

    function updateTimestamp() {
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
    }

    // Flash animation on update
    function flashElement(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove('flash');
        void el.offsetWidth; // Trigger reflow
        el.classList.add('flash');
      }
    }

    // Check API health
    async function checkHealth() {
      try {
        const res = await fetch(`${API_URL}/health`);
        if (res.ok) {
          setStatus('apiStatus', 'green');
        } else {
          setStatus('apiStatus', 'red');
        }
      } catch (err) {
        setStatus('apiStatus', 'red');
        addLog('API non accessible', 'error');
      }
    }

    // Fetch queue stats
    async function fetchStats() {
      if (!AUTH_TOKEN) return;

      try {
        const res = await fetch(`${API_URL}/api/queue`, {
          headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
        });

        if (res.ok) {
          const data = await res.json();
          updateMetrics(data.queue, data.stats);
          updateTimestamp();
          addLog('Données mises à jour', 'success');
        } else if (res.status === 401) {
          addLog('Token expiré - reconnectez-vous', 'error');
          showLoginRequired();
        }
      } catch (err) {
        addLog('Erreur de récupération des données', 'error');
      }
    }

    // Update all metrics
    function updateMetrics(queue, stats) {
      // Primary metrics
      const waiting = stats.waiting || 0;
      const seen = stats.seen || 0;
      const avgWait = stats.avgWait !== null ? stats.avgWait : '-';
      const noShows = stats.noShows || 0;

      document.getElementById('waiting').textContent = waiting;
      document.getElementById('seen').textContent = seen;
      document.getElementById('avgWait').textContent = avgWait;
      document.getElementById('noShows').textContent = noShows;

      // Secondary metrics
      document.getElementById('maxWait').textContent = stats.maxWait !== null ? stats.maxWait : '-';
      document.getElementById('lastConsult').textContent = stats.lastConsultationMins !== null ? stats.lastConsultationMins : '-';

      // Current patient
      const inConsultation = queue.find(p => p.status === 'IN_CONSULTATION');
      const nextPatient = queue.find(p => p.status === 'NOTIFIED' || p.status === 'WAITING');

      const currentCard = document.getElementById('currentPatientCard');
      const currentEl = document.getElementById('currentPatient');
      const nextEl = document.getElementById('nextPatient');

      if (inConsultation) {
        currentCard.classList.remove('empty');
        currentEl.textContent = inConsultation.patientName || 'Patient #' + inConsultation.position;
      } else {
        currentCard.classList.add('empty');
        currentEl.textContent = 'Aucun patient';
      }

      nextEl.textContent = nextPatient
        ? (nextPatient.patientName || 'Patient #' + nextPatient.position)
        : '-';

      // Flash updated values
      flashElement('waiting');
      flashElement('seen');
    }

    // Update doctor presence
    function updateDoctorPresence(isPresent) {
      const card = document.getElementById('doctorCard');
      const status = document.getElementById('doctorStatus');
      const label = document.getElementById('doctorLabel');

      if (isPresent) {
        card.className = 'card-small doctor-present';
        status.textContent = 'Présent';
        label.textContent = 'en service';
      } else {
        card.className = 'card-small doctor-absent';
        status.textContent = 'Absent';
        label.textContent = 'indisponible';
      }
    }

    // Reset stats
    async function resetStats() {
      if (!confirm('Remettre le compteur "Vus aujourd\'hui" à zéro?\n\nCette action supprimera les consultations terminées.')) {
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/queue/reset-stats`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
        });

        if (res.ok) {
          const data = await res.json();
          addLog(`Statistiques remises à zéro (${data.deletedCount} entrées supprimées)`, 'success');
          fetchStats();
        } else {
          addLog('Erreur lors de la remise à zéro', 'error');
        }
      } catch (err) {
        addLog('Erreur: ' + err.message, 'error');
      }
    }

    // Manual refresh
    function refresh() {
      addLog('Rafraichissement manuel...', 'info');
      checkHealth();
      fetchStats();
      fetchMetrics();
    }

    // Fetch Prometheus metrics for connection count
    async function fetchMetrics() {
      try {
        const res = await fetch(`${API_URL}/metrics`);
        if (res.ok) {
          const text = await res.text();
          const socketMatch = text.match(/doctorq_socket_connections_active (\d+)/);
          if (socketMatch) {
            document.getElementById('connections').textContent = socketMatch[1];
          }
        }
      } catch (err) {
        // Metrics might not be accessible
      }
    }

    // Socket.io connection
    function connectSocket() {
      if (!AUTH_TOKEN) {
        setStatus('socketStatus', 'yellow');
        return;
      }

      try {
        // Parse clinic ID from JWT
        const payload = JSON.parse(atob(AUTH_TOKEN.split('.')[1]));
        clinicId = payload.clinicId;

        socket = io(API_URL, {
          transports: ['websocket', 'polling'],
          timeout: 10000,
        });

        socket.on('connect', () => {
          setStatus('socketStatus', 'green');
          addLog('Socket connecté', 'success');

          if (clinicId) {
            socket.emit('join:clinic', { clinicId, token: AUTH_TOKEN });
            addLog('Rejoint la salle clinique', 'info');
          }
        });

        socket.on('disconnect', (reason) => {
          setStatus('socketStatus', 'red');
          addLog('Socket déconnecté: ' + reason, 'error');
        });

        socket.on('connect_error', (error) => {
          setStatus('socketStatus', 'red');
          addLog('Erreur socket: ' + error.message, 'error');
        });

        socket.on('queue:updated', (data) => {
          addLog('Mise à jour temps réel reçue', 'success');
          updateMetrics(data.queue, data.stats);
          updateTimestamp();
        });

        socket.on('doctor:presence', (data) => {
          updateDoctorPresence(data.isDoctorPresent);
          addLog('Docteur ' + (data.isDoctorPresent ? 'marqué présent' : 'marqué absent'), 'info');
        });

      } catch (err) {
        setStatus('socketStatus', 'red');
        addLog('Erreur initialisation socket: ' + err.message, 'error');
      }
    }

    // Show login required message
    function showLoginRequired() {
      document.getElementById('loginRequired').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
    }

    // Initialize
    function init() {
      if (!AUTH_TOKEN) {
        showLoginRequired();
        addLog('Token non trouvé - connexion requise', 'error');
        setStatus('apiStatus', 'yellow');
        setStatus('socketStatus', 'yellow');
        checkHealth();
        return;
      }

      addLog('Monitor initialisé', 'success');
      checkHealth();
      fetchStats();
      fetchMetrics();
      connectSocket();

      // Poll every 60 seconds as fallback
      setInterval(() => {
        checkHealth();
        fetchMetrics();
      }, 60000);
    }

    // Start
    init();
  </script>
</body>
</html>
