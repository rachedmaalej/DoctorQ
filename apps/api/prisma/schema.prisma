// DoctorQ Database Schema
// Virtual Queue Management for Tunisia Medical Practices

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // For direct connections (migrations), use DIRECT_URL if available
  // directUrl = env("DIRECT_URL")
}

// Connection Pool Configuration:
// - Supabase pgbouncer (pooler URL) handles pooling in production
// - Add ?connection_limit=10&pool_timeout=30 to DATABASE_URL for tuning
// - Use DIRECT_URL for migrations when using pgbouncer

model Clinic {
  id                  String       @id @default(uuid())
  name                String
  doctorName          String?
  phone               String?
  address             String?
  language            String       @default("fr") // fr, ar
  avgConsultationMins Int          @default(10)
  isActive            Boolean      @default(true)

  // Auth
  email               String       @unique
  passwordHash        String

  // Settings
  notifyAtPosition    Int          @default(2)  // Notify when X patients away
  enableWhatsApp      Boolean      @default(false)
  isDoctorPresent     Boolean      @default(false)  // Track if doctor is currently seeing patients

  // Business type customization
  businessType        String       @default("medical")  // medical, retail, restaurant, etc.
  showAppointments    Boolean      @default(true)       // Whether to show appointment time field

  // Activity tracking
  lastLoginAt         DateTime?    // Last login timestamp for churn detection

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  queueEntries        QueueEntry[]
  dailyStats          DailyStat[]
  paymentRecords      PaymentRecord[]

  @@index([email])
}

model QueueEntry {
  id            String        @id @default(uuid())
  clinicId      String
  clinic        Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientName   String?
  patientPhone  String
  position      Int

  status        QueueStatus   @default(WAITING)
  checkInMethod CheckInMethod @default(MANUAL)

  // Appointment support (v0.3)
  appointmentTime DateTime?   // Scheduled appointment time (null = walk-in)

  // Manual reordering support
  // When set, this patient's position is "pinned" and won't be auto-recalculated
  // Value is the timestamp when manually reordered (used for ordering pinned patients)
  priorityOrder DateTime?

  arrivedAt     DateTime      @default(now())
  notifiedAt    DateTime?     // When "almost your turn" sent
  calledAt      DateTime?     // When called for consultation
  completedAt   DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Performance indexes for common queries
  @@index([clinicId, status])                       // Filter active queue by clinic
  @@index([clinicId, arrivedAt])                    // Order by arrival time
  @@index([clinicId, createdAt])                    // Order by creation time
  @@index([clinicId, appointmentTime])              // Order by appointment time
  @@index([clinicId, status, position])             // Queue recalculation queries
  @@index([clinicId, status, arrivedAt])            // Duplicate check (phone + status + date)
  @@index([clinicId, patientPhone, status])         // Fast duplicate detection
  @@index([patientPhone])                           // Global phone lookup
  @@index([status, completedAt])                    // Stats: last completed patient
  @@index([clinicId, calledAt])                     // Stats: average wait time calculation
}

enum QueueStatus {
  WAITING
  NOTIFIED      // "Almost your turn" sent
  IN_CONSULTATION
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  WHATSAPP
  SMS
}

model DailyStat {
  id            String   @id @default(uuid())
  clinicId      String
  clinic        Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  date          DateTime @db.Date
  totalPatients Int      @default(0)
  avgWaitMins   Int?
  noShows       Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([clinicId, date])
  @@index([clinicId, date])
}

model PaymentRecord {
  id         String   @id @default(uuid())
  clinicId   String
  clinic     Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  amount     Int      // Amount in millimes (50000 = 50 TND)
  month      DateTime @db.Date  // Payment for which month (first day of month)
  method     String   // "konnect", "bank_transfer", "cash", "cheque"
  reference  String?  // Konnect paymentRef or bank transfer ref
  notes      String?
  status     String   @default("paid") // "paid", "pending", "failed"

  paidAt     DateTime @default(now())
  recordedBy String   // Admin email who recorded it

  createdAt  DateTime @default(now())

  @@unique([clinicId, month])
  @@index([clinicId])
  @@index([month])
}
