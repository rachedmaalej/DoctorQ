// MediBook Database Schema
// Appointment Management for Tunisia Medical Practices
// Shares database with DoctorQ

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EXISTING MODELS (from DoctorQ)
// ============================================

model Clinic {
  id                  String       @id @default(uuid())
  name                String
  doctorName          String?
  phone               String?
  address             String?
  language            String       @default("fr") // fr, ar
  avgConsultationMins Int          @default(15)
  isActive            Boolean      @default(true)

  // Auth
  email               String       @unique
  passwordHash        String

  // Settings
  notifyAtPosition    Int          @default(2)
  enableWhatsApp      Boolean      @default(false)

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // DoctorQ relations
  queueEntries        QueueEntry[]
  dailyStats          DailyStat[]

  // MediBook relations
  doctors             Doctor[]
  patients            Patient[]
  appointments        Appointment[]

  @@index([email])
}

model QueueEntry {
  id            String        @id @default(uuid())
  clinicId      String
  clinic        Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientName   String?
  patientPhone  String
  position      Int

  status        QueueStatus   @default(WAITING)
  checkInMethod CheckInMethod @default(MANUAL)

  // MediBook integration
  appointmentTime DateTime?
  appointmentId   String?       // Link to Appointment

  arrivedAt     DateTime      @default(now())
  notifiedAt    DateTime?
  calledAt      DateTime?
  completedAt   DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([clinicId, status])
  @@index([clinicId, arrivedAt])
  @@index([clinicId, createdAt])
  @@index([clinicId, appointmentTime])
}

enum QueueStatus {
  WAITING
  NOTIFIED
  IN_CONSULTATION
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  WHATSAPP
  SMS
  APPOINTMENT   // via MediBook
}

model DailyStat {
  id            String   @id @default(uuid())
  clinicId      String
  clinic        Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  date          DateTime @db.Date
  totalPatients Int      @default(0)
  avgWaitMins   Int?
  noShows       Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([clinicId, date])
  @@index([clinicId, date])
}

// ============================================
// MEDIBOOK MODELS
// ============================================

model Doctor {
  id              String        @id @default(uuid())
  clinicId        String
  clinic          Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  name            String
  specialty       String?
  phone           String?
  email           String?
  color           String?       // Hex color for calendar (e.g., "#4f46e5")

  // Working hours stored as JSON
  // Format: { "monday": { "start": "09:00", "end": "17:00" }, ... }
  workingHours    Json?

  // Default appointment duration in minutes
  slotDuration    Int           @default(15)

  isActive        Boolean       @default(true)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  appointments    Appointment[]

  @@index([clinicId])
  @@index([clinicId, isActive])
}

model Patient {
  id                 String        @id @default(uuid())
  clinicId           String
  clinic             Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  name               String
  phone              String        // Required - used for reminders
  email              String?
  dateOfBirth        DateTime?
  gender             Gender?
  notes              String?       // Internal notes (allergies, preferences, etc.)

  // Preferences
  preferredDoctorId  String?       // Reference to Doctor.id
  reminderPreference ReminderType  @default(SMS)

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  appointments       Appointment[]

  // Phone must be unique within a clinic
  @@unique([clinicId, phone])
  @@index([clinicId])
  @@index([clinicId, name])
}

model Appointment {
  id              String            @id @default(uuid())
  clinicId        String
  clinic          Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  doctorId        String
  doctor          Doctor            @relation(fields: [doctorId], references: [id])

  patientId       String
  patient         Patient           @relation(fields: [patientId], references: [id])

  // Scheduling
  date            DateTime          @db.Date     // Date only (2024-01-15)
  startTime       DateTime                       // Full datetime for start
  endTime         DateTime                       // Full datetime for end
  duration        Int                            // Duration in minutes

  // Status tracking
  status          AppointmentStatus @default(SCHEDULED)

  // Details
  reason          String?           // Reason for visit
  notes           String?           // Additional notes

  // Reminders
  reminder24hSent Boolean           @default(false)
  reminder1hSent  Boolean           @default(false)

  // Integration with DoctorQ
  queueEntryId    String?           // Link to QueueEntry when checked in

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Indexes for common queries
  @@index([clinicId, date])
  @@index([doctorId, date])
  @@index([patientId])
  @@index([status])
}

// ============================================
// ENUMS
// ============================================

enum AppointmentStatus {
  SCHEDULED       // Appointment booked, not yet confirmed
  CONFIRMED       // Patient confirmed (via SMS reply or phone)
  CHECKED_IN      // Patient arrived, linked to QueueEntry
  IN_PROGRESS     // Currently with doctor
  COMPLETED       // Appointment finished
  CANCELLED       // Cancelled by clinic or patient
  NO_SHOW         // Patient didn't arrive
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ReminderType {
  SMS
  WHATSAPP
  NONE
}
